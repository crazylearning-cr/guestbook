name: Guestbook CI/CD Pipeline

permissions:
  contents: write

on:
  push:
    branches:
      - main

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/guestbook
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      COMMIT_EMAIL: "github-actions@example.com"
      COMMIT_NAME: "GitHub Actions Bot"

    steps:
    # ----------------------------------------
    # Checkout source code
    # ----------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ----------------------------------------
    # Python setup & tests
    # ----------------------------------------
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        cd app
        pip install -r requirements.txt
        pip install pytest pytest-cov

    - name: Run tests
      run: |
        pytest --cov=app --cov-report=term-missing --cov-fail-under=80 app/ || true

    # ----------------------------------------
    # Docker build & push
    # ----------------------------------------
    - name: Log in to Docker Hub
      run: |
        echo "${DOCKERHUB_PASSWORD}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin

    - name: Build & push Docker image
      run: |
        IMAGE_TAG=$(git rev-parse --short HEAD)
        echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

        docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ./app
        docker push ${IMAGE_NAME}:${IMAGE_TAG}

    # ----------------------------------------
    # Install Kustomize
    # ----------------------------------------
    - name: Install kustomize
      run: |
        curl -s https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh | bash
        sudo mv kustomize /usr/local/bin/

    # ----------------------------------------
    # Update Kustomize overlay (PROD)
    # ----------------------------------------
    - name: Update k8s manifest image (prod overlay)
      run: |
        cd k8s-manifests/guestbook-rollout/overlays/dev

        echo "Before update:"
        cat kustomization.yaml

        kustomize edit set image \
          udemykcloud534/guestbook=${IMAGE_NAME}:${IMAGE_TAG}

        echo "After update:"
        cat kustomization.yaml

    # ----------------------------------------
    # Commit & push manifest changes
    # ----------------------------------------
    - name: Commit and push manifest changes
      run: |
        git config user.email "${COMMIT_EMAIL}"
        git config user.name "${COMMIT_NAME}"

        git add k8s-manifests/guestbook-rollout/overlays/prod/kustomization.yaml
        git commit -m "chore: update guestbook image to ${IMAGE_TAG}" || echo "No changes to commit"
        git push origin main
