name: Guestbook CI â€“ Build & Propose Prod Promotion

permissions:
  contents: write
  pull-requests: write

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'k8s-manifests/**'

jobs:
  build-and-propose:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/guestbook
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
      COMMIT_EMAIL: github-actions@example.com
      COMMIT_NAME: GitHub Actions Bot

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # ----------------------------
    # Build & Push Image
    # ----------------------------
    - name: Docker login
      run: |
        echo "${DOCKERHUB_PASSWORD}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin

    - name: Build & push image
      run: |
        IMAGE_TAG=$(git rev-parse --short HEAD)
        echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

        docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ./app
        docker push ${IMAGE_NAME}:${IMAGE_TAG}

    # ----------------------------
    # Prepare PROD promotion branch
    # ----------------------------
    - name: Install kustomize
      run: |
        curl -s https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh | bash
        sudo mv kustomize /usr/local/bin/

    - name: Update prod manifest
      run: |
        cd k8s-manifests/guestbook-rollout/overlays/prod
        kustomize edit set image \
          udemykcloud534/guestbook=${IMAGE_NAME}:${IMAGE_TAG}

    - name: Create Pull Request
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "prod: promote guestbook to ${IMAGE_TAG}"
        branch: promote-prod-${{ env.IMAGE_TAG }}
        base: main
        title: "Promote guestbook to PROD (${IMAGE_TAG})"
        body: |
          Image: ${IMAGE_NAME}:${IMAGE_TAG}